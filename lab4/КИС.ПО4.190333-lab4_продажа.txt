
Процедура КнопкаСформироватьНажатие(Кнопка)
	ФормированиеОтчета();
КонецПроцедуры

Процедура КонтрагентПриИзменении(Элемент)
	Контрагент = Договор.Контрагент;
	ФормированиеОтчета();
КонецПроцедуры

Процедура ФормированиеОтчета()
	// Запрос табличной части товаров
	ЗапросТоваров = Новый Запрос;
	ЗапросТоваров.Текст = "ВЫБРАТЬ
			               |	РеализацияТоваровУслугТовары.Номенклатура,
			               |	РеализацияТоваровУслугТовары.ЕдиницаИзмерения,
			               |	РеализацияТоваровУслугТовары.Количество,
			               |	РеализацияТоваровУслугТовары.Цена,
			               |	РеализацияТоваровУслугТовары.Сумма,
			               |	РеализацияТоваровУслугТовары.СтавкаНДС,
			               |	РеализацияТоваровУслугТовары.СуммаНДС
			               |ИЗ
			               |	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
			               |ГДЕ
			               |	РеализацияТоваровУслугТовары.Ссылка = &Ссылка";
	ЗапросТоваров.УстановитьПараметр("Ссылка", Договор.Ссылка);
	РезультатЗапросаТоваров = ЗапросТоваров.Выполнить().Выгрузить();
	
	// Запрос табличной части услуг
	ЗапросУслуг = Новый Запрос;
	ЗапросУслуг.Текст = "ВЫБРАТЬ
	                    |	РеализацияТоваровУслугУслуги.Номенклатура,
	                    |	РеализацияТоваровУслугУслуги.Количество,
	                    |	РеализацияТоваровУслугУслуги.Цена,
	                    |	РеализацияТоваровУслугУслуги.Сумма,
	                    |	РеализацияТоваровУслугУслуги.СтавкаНДС,
	                    |	РеализацияТоваровУслугУслуги.СуммаНДС
	                    |ИЗ
	                    |	Документ.РеализацияТоваровУслуг.Услуги КАК РеализацияТоваровУслугУслуги
	                    |ГДЕ
	                    |	РеализацияТоваровУслугУслуги.Ссылка = &Ссылка";
	ЗапросУслуг.УстановитьПараметр("Ссылка", Договор.Ссылка);
	РезультатЗапросаУслуг = ЗапросУслуг.Выполнить().Выгрузить();
	
	// Запрос табличной части агентских услуг
	ЗапросАгентскихУслуг = Новый Запрос;
	ЗапросАгентскихУслуг.Текст = "ВЫБРАТЬ
				               |	РеализацияТоваровУслугАгентскиеУслуги.Номенклатура,
				               |	РеализацияТоваровУслугАгентскиеУслуги.Количество,
				               |	РеализацияТоваровУслугАгентскиеУслуги.Цена,
				               |	РеализацияТоваровУслугАгентскиеУслуги.Сумма,
				               |	РеализацияТоваровУслугАгентскиеУслуги.СтавкаНДС,
				               |	РеализацияТоваровУслугАгентскиеУслуги.СуммаНДС
				               |ИЗ
				               |	Документ.РеализацияТоваровУслуг.АгентскиеУслуги КАК РеализацияТоваровУслугАгентскиеУслуги
				               |ГДЕ
				               |	РеализацияТоваровУслугАгентскиеУслуги.Ссылка = &Ссылка";
	ЗапросАгентскихУслуг.УстановитьПараметр("Ссылка", Договор.Ссылка);
	РезультатЗапросаАгентскихУслуг = ЗапросАгентскихУслуг.Выполнить().Выгрузить();
	
	ТабДок = ЭлементыФормы.ПолеТабличногоДокумента1;
	ТабДок.Очистить();
	
	// Получаю области макетов
	Макет = ПолучитьМакет("Макет1");
	
	Шапка 					= Макет.ПолучитьОбласть("Шапка");
	
	ШапкаТоваров 			= Макет.ПолучитьОбласть("ШапкаТоваров");
	УровеньТовара 			= Макет.ПолучитьОбласть("УровеньТовара");
	ПодвалТоваров 			= Макет.ПолучитьОбласть("ПодвалТоваров");
	
	ШапкаУслуг 				= Макет.ПолучитьОбласть("ШапкаУслуг");
	УровеньУслуг 			= Макет.ПолучитьОбласть("УровеньУслуг");
	ПодвалУслуг 			= Макет.ПолучитьОбласть("ПодвалУслуг");
	
	ШапкаАгентскихУслуг 	= Макет.ПолучитьОбласть("ШапкаУслуг");
	УровеньАгентскихУслуг 	= Макет.ПолучитьОбласть("УровеньУслуг");
	ПодвалАгентскихУслуг	= Макет.ПолучитьОбласть("ПодвалУслуг");
	
	// Заполняю шапку
	Шапка.Параметры.Договор = Договор;
	Шапка.Параметры.Контрагент = Контрагент;
	ТабДок.Вывести(Шапка);
	
	// Заполняю шапку товаров
	ТабДок.Вывести(ШапкаТоваров);
	
	// Заполняю уровень товаров
	КоличествоПозицийТоваров = 0;
	Для Каждого СтрокаТЗ Из РезультатЗапросаТоваров Цикл
		УровеньТовара.Параметры.Номенклатура = СтрокаТЗ.Номенклатура;
		УровеньТовара.Параметры.Количество = СтрокаТЗ.Количество;
		УровеньТовара.Параметры.ЦенаБезНдс = СтрокаТЗ.Цена;
		УровеньТовара.Параметры.СуммаБезНдс = СтрокаТЗ.Сумма;
		УровеньТовара.Параметры.Ндс = СтрокаТЗ.СтавкаНдс;
		УровеньТовара.Параметры.СуммаНдс = СтрокаТЗ.СуммаНдс;
		УровеньТовара.Параметры.Всего = СтрокаТЗ.Количество * СтрокаТЗ.СуммаНдс;
		ТабДок.Вывести(УровеньТовара);
		КоличествоПозицийТоваров = КоличествоПозицийТоваров + 1;
	КонецЦикла;
	
	// Заполняю подвал товаров
	ПодвалТоваров.Параметры.количество = КоличествоПозицийТоваров;
	ТабДок.Вывести(ПодвалТоваров);
	
	// Заполняю шапку услуг
	ТабДок.Вывести(ШапкаУслуг);
	
	// Заполняю уровень услуг
	КоличествоПозицийУслуг = 0;
	Для Каждого СтрокаТЗ Из РезультатЗапросаУслуг Цикл
		УровеньУслуг.Параметры.Номенклатура = СтрокаТЗ.Номенклатура;
		УровеньУслуг.Параметры.Количество = СтрокаТЗ.Количество;
		УровеньУслуг.Параметры.ЦенаБезНдс = СтрокаТЗ.Цена;
		УровеньУслуг.Параметры.СуммаБезНдс = СтрокаТЗ.Сумма;
		УровеньУслуг.Параметры.Ндс = СтрокаТЗ.СтавкаНдс;
		УровеньУслуг.Параметры.СуммаНдс = СтрокаТЗ.СуммаНдс;
		УровеньУслуг.Параметры.Всего = СтрокаТЗ.Количество * СтрокаТЗ.СуммаНдс;
		ТабДок.Вывести(УровеньУслуг);
		КоличествоПозицийУслуг = КоличествоПозицийУслуг + 1;
	КонецЦикла;
	
	// Заполняю подвал услуг
	ПодвалУслуг.Параметры.количество = КоличествоПозицийУслуг;
	ТабДок.Вывести(ПодвалУслуг);
	
	// Заполняю шапку агентских услуг
	ТабДок.Вывести(ШапкаАгентскихУслуг);
	
	// Заполняю уровень агентских услуг
	КоличествоПозицийАгентскихУслуг = 0;
	Для Каждого СтрокаТЗ Из РезультатЗапросаУслуг Цикл
		УровеньАгентскихУслуг.Параметры.Номенклатура = СтрокаТЗ.Номенклатура;
		УровеньАгентскихУслуг.Параметры.Количество = СтрокаТЗ.Количество;
		УровеньАгентскихУслуг.Параметры.ЦенаБезНдс = СтрокаТЗ.Цена;
		УровеньАгентскихУслуг.Параметры.СуммаБезНдс = СтрокаТЗ.Сумма;
		УровеньАгентскихУслуг.Параметры.Ндс = СтрокаТЗ.СтавкаНдс;
		УровеньАгентскихУслуг.Параметры.СуммаНдс = СтрокаТЗ.СуммаНдс;
		УровеньАгентскихУслуг.Параметры.Всего = СтрокаТЗ.Количество * СтрокаТЗ.СуммаНдс;
		ТабДок.Вывести(УровеньАгентскихУслуг);
		КоличествоПозицийАгентскихУслуг = КоличествоПозицийАгентскихУслуг + 1;
	КонецЦикла;
	
	// Заполняю подвал агентских услуг
	ПодвалАгентскихУслуг.Параметры.количество = КоличествоПозицийАгентскихУслуг;
	ТабДок.Вывести(ПодвалАгентскихУслуг);

КонецПроцедуры;
